<section class="crear-hero">
  <div>
    <p class="kicker">Nueva rutina</p>
    <h1>Arma ejercicios y series sin bloques</h1>
    <p class="lede">Edita cada serie por ejercicio y agrega varios a la vez desde el catalogo.</p>
    <div class="hero-actions">
      <a class="btn ghost" routerLink="/rutinas">Volver a listadas</a>
      <button class="btn primary" type="button" (click)="guardar()" [disabled]="cargando">Guardar rutina</button>
    </div>
  </div>
</section>

<form class="crear-form" (ngSubmit)="guardar()">
  <div class="grid">
    <label>
      Nombre
      <input type="text" name="titulo" [(ngModel)]="rutina.titulo" required>
    </label>
    <label>
      Objetivo
      <input type="text" name="objetivo" [(ngModel)]="rutina.objetivo" required>
    </label>
    <label>
      Nivel
      <select name="nivel" [(ngModel)]="rutina.nivel">
        <option value="Principiante">Principiante</option>
        <option value="Intermedio">Intermedio</option>
        <option value="Avanzado">Avanzado</option>
      </select>
    </label>
    <label>
      Semanas
      <input type="number" min="1" max="20" name="semanas" [(ngModel)]="rutina.semanas">
    </label>
    <label>
      Frecuencia semanal
      <input type="number" min="1" max="7" name="frecuencia" [(ngModel)]="rutina.frecuencia">
    </label>
    <label>
      Duracion por sesion (min)
      <input type="number" min="20" max="180" name="duracionMin" [(ngModel)]="rutina.duracionMin">
    </label>
    <label>
      Descanso base (seg)
      <input type="number" min="10" max="600" name="descansoSeg" [(ngModel)]="rutina.descansoSeg">
    </label>
    <label>
      Imagen (URL)
      <input type="text" name="imagen" placeholder="https://..." [(ngModel)]="rutina.imagen">
    </label>
    <label class="checkbox-label">
      Disponible como plantilla
      <input type="checkbox" name="esGlobal" [(ngModel)]="rutina.esGlobal">
    </label>
  </div>

  <label class="full">
    Descripcion corta
    <textarea name="descripcion" rows="3" [(ngModel)]="rutina.descripcion"></textarea>
  </label>

  <section class="ejercicios-panel">
    <header class="ejercicios-header">
      <div>
        <p class="kicker">Ejercicios</p>
        <p class="muted">Cada ejercicio guarda sus series. Agrega desde el catalogo o manualmente.</p>
      </div>
      <div class="ejercicios-actions">
        <button class="btn ghost" type="button" (click)="agregarEjercicioManual()">+ Agregar manual</button>
        <button class="btn primary" type="button" (click)="irASelector()">+ Agregar ejercicios</button>
      </div>
    </header>

    <p class="muted total">Total: {{ totalEjercicios }} ejercicios</p>

    <article class="ejercicio-card" *ngFor="let ej of rutina.ejercicios; let i = index; trackBy: trackByIndex">
      <div class="ejercicio-head">
        <div class="avatar">{{ i + 1 }}</div>
        <div class="ejercicio-meta">
          <input type="text" [name]="'ejercicio' + i" [(ngModel)]="ej.nombre" placeholder="Nombre del ejercicio">
          <div class="chips">
            <select [name]="'grupo' + i" [(ngModel)]="ej.grupoMuscular">
              <option [ngValue]="undefined">Grupo</option>
              <option value="Pecho">Pecho</option>
              <option value="Espalda">Espalda</option>
              <option value="Piernas">Piernas</option>
              <option value="Hombros">Hombros</option>
              <option value="Brazos">Brazos</option>
              <option value="Core">Core</option>
              <option value="Fullbody">Fullbody</option>
              <option value="Cardio">Cardio</option>
            </select>
            <select [name]="'nivel' + i" [(ngModel)]="ej.nivel">
              <option [ngValue]="undefined">Nivel</option>
              <option value="Principiante">Principiante</option>
              <option value="Intermedio">Intermedio</option>
              <option value="Avanzado">Avanzado</option>
            </select>
            <select [name]="'equipamiento' + i" [(ngModel)]="ej.equipamiento">
              <option [ngValue]="undefined">Equipo</option>
              <option value="Peso corporal">Peso corporal</option>
              <option value="Mancuernas">Mancuernas</option>
              <option value="Barra">Barra</option>
              <option value="Maquina">Maquina</option>
              <option value="Bandas">Bandas</option>
              <option value="Kettlebell">Kettlebell</option>
            </select>
          </div>
        </div>
        <div class="orden-actions">
          <button class="btn ghost tiny" type="button" (click)="moverEjercicio(i, 'up')" [disabled]="i === 0">Subir</button>
          <button class="btn ghost tiny" type="button" (click)="moverEjercicio(i, 'down')" [disabled]="i === rutina.ejercicios.length - 1">Bajar</button>
          <button class="btn ghost tiny" type="button" (click)="quitarEjercicio(i)">Quitar</button>
        </div>
      </div>

      <label class="notas">
        <span>Notas</span>
        <textarea [name]="'notas' + i" rows="2" [(ngModel)]="ej.notas" placeholder="Ajustes, tempo, tips"></textarea>
      </label>

      <div class="series">
        <div class="serie-row" *ngFor="let serie of ej.series; let s = index; trackBy: trackByIndex">
          <span class="pill">Serie {{ serie.orden }}</span>
          <label>
            Reps
            <input type="number" min="1" [name]="'reps' + i + '-' + s" [(ngModel)]="serie.repeticiones">
          </label>
          <label>
            Carga / kg
            <input type="text" [name]="'carga' + i + '-' + s" [(ngModel)]="serie.carga">
          </label>
          <label>
            Descanso (s)
            <input type="number" min="0" [name]="'descanso' + i + '-' + s" [(ngModel)]="serie.descansoSeg">
          </label>
          <button class="btn ghost tiny" type="button" (click)="quitarSerie(i, s)">Quitar</button>
        </div>
        <button class="btn small" type="button" (click)="agregarSerie(i)">+ Agregar serie</button>
      </div>
    </article>

    <div class="empty" *ngIf="!rutina.ejercicios.length">
      <p>No hay ejercicios aun. Usa "Agregar ejercicios" para traer varios a la vez.</p>
      <button class="btn primary" type="button" (click)="irASelector()">Abrir catalogo</button>
    </div>
  </section>

  <div class="form-actions">
    <button class="btn ghost" type="button" routerLink="/rutinas">Cancelar</button>
    <button class="btn primary" type="submit" [disabled]="cargando">Guardar</button>
  </div>

  <p class="alert muted" *ngIf="cargando">Guardando rutina en el servidor...</p>
  <p class="alert success" *ngIf="mensaje">{{ mensaje }}</p>
  <p class="alert error" *ngIf="error">{{ error }}</p>
</form>
